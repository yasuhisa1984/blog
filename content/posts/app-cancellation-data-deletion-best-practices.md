---
title: "ã‚¢ãƒ—ãƒªè§£ç´„æ™‚ã€DBã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯ã©ã“ã¾ã§æ¶ˆã™ã¹ãã‹ï¼šæ³•å‹™ãƒ»é‹ç”¨ãƒ»è¨­è¨ˆã®è¦³ç‚¹ã‹ã‚‰è€ƒãˆã‚‹å®Œå…¨ã‚¬ã‚¤ãƒ‰"
date: 2024-12-16
draft: false
categories: ["ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ"]
tags: ["ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹", "è¨­è¨ˆ", "GDPR", "å€‹äººæƒ…å ±ä¿è­·", "SaaS", "é‹ç”¨", "æ³•å‹™"]
description: "è§£ç´„ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆã™ã¹ãï¼Ÿæ®‹ã™ã¹ãï¼Ÿæ³•çš„è¦ä»¶ã€ç›£æŸ»å¯¾å¿œã€å†ç™»éŒ²ã€é‹ç”¨ã‚³ã‚¹ãƒˆã‚’è€ƒæ…®ã—ãŸã€ç¾å®Ÿçš„ãªãƒ‡ãƒ¼ã‚¿å‰Šé™¤æˆ¦ç•¥ã‚’å¾¹åº•è§£èª¬ã€‚"
cover:
  image: "https://images.unsplash.com/photo-1558494949-ef010cbdcc31?w=800"
  alt: "ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ³ã‚¿ãƒ¼ã®ã‚µãƒ¼ãƒãƒ¼"
  relative: false
---

```mermaid
flowchart TB
    subgraph Cancel["ğŸšª è§£ç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ"]
        REQ[ãƒ¦ãƒ¼ã‚¶ãƒ¼è§£ç´„]
    end

    subgraph Strategy["ğŸ“‹ ãƒ‡ãƒ¼ã‚¿å‡¦ç†æˆ¦ç•¥"]
        SOFT[è«–ç†å‰Šé™¤]
        ANON[åŒ¿ååŒ–]
        HARD[ç‰©ç†å‰Šé™¤]
        ARCHIVE[ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–]
    end

    subgraph Factors["âš–ï¸ åˆ¤æ–­è¦ç´ "]
        LAW[æ³•çš„è¦ä»¶]
        AUDIT[ç›£æŸ»è¦ä»¶]
        REJOIN[å†ç™»éŒ²å¯¾å¿œ]
        COST[é‹ç”¨ã‚³ã‚¹ãƒˆ]
    end

    REQ --> Strategy
    LAW --> SOFT
    LAW --> HARD
    AUDIT --> ARCHIVE
    REJOIN --> SOFT
    COST --> HARD

    style Cancel fill:#ffebee
    style Strategy fill:#e3f2fd
    style Factors fill:#fff3e0
```

## ã€Œè§£ç´„ã—ãŸã‚‰å…¨éƒ¨æ¶ˆã›ã°ã„ã„ã‚“ã§ã—ã‚‡ï¼Ÿã€ã¨ã„ã†èª¤è§£

SaaS ã‚„ã‚¢ãƒ—ãƒªã‚’é‹ç”¨ã—ã¦ã„ã‚‹ã¨ã€å¿…ãšç›´é¢ã™ã‚‹å•é¡ŒãŒã‚ã‚‹ã€‚

**ã€Œè§£ç´„ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã€ã©ã†ã™ã‚‹ï¼Ÿã€**

ä¸€è¦‹ã‚·ãƒ³ãƒ—ãƒ«ã«è¦‹ãˆã‚‹ã“ã®å•é¡Œã€‚å®Ÿã¯ã€è€ƒæ…®ã™ã¹ãã“ã¨ãŒå±±ã»ã©ã‚ã‚‹ã€‚

```sql
-- ã“ã‚“ãªå˜ç´”ãªè©±ã§ã¯ãªã„
DELETE FROM users WHERE id = 123;
DELETE FROM orders WHERE user_id = 123;
DELETE FROM payments WHERE user_id = 123;
-- ...æœ¬å½“ã«ã“ã‚Œã§ã„ã„ã®ã‹ï¼Ÿ
```

ç¾å ´ã§ã‚ˆãèãå£°ï¼š

- ã€ŒGDPR ãŒã‚ã‚‹ã‹ã‚‰å…¨éƒ¨æ¶ˆã•ãªã„ã¨ã„ã‘ãªã„ã‚“ã§ã—ã‚‡ï¼Ÿã€
- ã€Œæ¶ˆã—ãŸã‚‰å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒåˆã‚ãªããªã£ãŸ...ã€
- ã€Œè§£ç´„ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæˆ»ã£ã¦ããŸã‘ã©ã€ãƒ‡ãƒ¼ã‚¿å…¨éƒ¨æ¶ˆãˆã¦ã¦æ€’ã‚‰ã‚ŒãŸã€
- ã€Œç›£æŸ»ã§ã€ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å–å¼•å±¥æ­´ã‚’è¦‹ã›ã¦ã€ã¨è¨€ã‚ã‚ŒãŸã‘ã©ã€æ¶ˆã—ã¦ã—ã¾ã£ãŸã€

**ã€Œå…¨éƒ¨æ¶ˆã™ã€ã‚‚ã€Œå…¨éƒ¨æ®‹ã™ã€ã‚‚é–“é•ã„ã ã€‚**

ã“ã®è¨˜äº‹ã§ã¯ã€æ³•å‹™ãƒ»é‹ç”¨ãƒ»è¨­è¨ˆã®3ã¤ã®è¦³ç‚¹ã‹ã‚‰ã€è§£ç´„æ™‚ã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤æˆ¦ç•¥ã‚’å¾¹åº•çš„ã«è§£èª¬ã™ã‚‹ã€‚

---

## ãªãœã€Œå…¨éƒ¨æ¶ˆã™ã€ãŒå±é™ºãªã®ã‹

### å•é¡Œ1ï¼šæ³•çš„ã«æ¶ˆã›ãªã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹

```
ã€æ—¥æœ¬ã®æ³•çš„ä¿å­˜ç¾©å‹™ã®ä¾‹ã€‘

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¸³ç°¿ãƒ»å–å¼•è¨˜éŒ²        â”‚ 7å¹´é–“ï¼ˆæ³•äººç¨æ³•ï¼‰      â”‚
â”‚ è«‹æ±‚æ›¸ãƒ»é ˜åæ›¸        â”‚ 7å¹´é–“ï¼ˆæ³•äººç¨æ³•ï¼‰      â”‚
â”‚ å¥‘ç´„æ›¸              â”‚ 10å¹´é–“ï¼ˆå•†æ³•ï¼‰        â”‚
â”‚ åŠ´åƒé–¢ä¿‚æ›¸é¡         â”‚ 3ã€œ5å¹´é–“ï¼ˆåŠ´åƒåŸºæº–æ³•ï¼‰  â”‚
â”‚ åŒ»ç™‚è¨˜éŒ²            â”‚ 5å¹´é–“ï¼ˆåŒ»å¸«æ³•ï¼‰        â”‚
â”‚ é‡‘èå–å¼•è¨˜éŒ²         â”‚ 10å¹´é–“ï¼ˆçŠ¯åæ³•ï¼‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è§£ç´„ã—ãŸã‹ã‚‰ã¨ã„ã£ã¦ã€å–å¼•è¨˜éŒ²ã‚’æ¶ˆã™ã¨æ³•ä»¤é•åã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚**

### å•é¡Œ2ï¼šç›£æŸ»ãƒ»è¨´è¨Ÿå¯¾å¿œãŒã§ããªããªã‚‹

```
ã‚·ãƒŠãƒªã‚ªï¼šè§£ç´„ã‹ã‚‰1å¹´å¾Œã«è¨´è¨Ÿ

å¼è­·å£«ã€Œã“ã®é¡§å®¢ã¨ã®å–å¼•å±¥æ­´ã‚’è¨¼æ‹ ã¨ã—ã¦æå‡ºã—ã¦ãã ã•ã„ã€
ã‚ãªãŸã€Œè§£ç´„æ™‚ã«æ¶ˆã—ã¾ã—ãŸ...ã€
å¼è­·å£«ã€Œ...ã€
```

### å•é¡Œ3ï¼šãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ã‚¹ãŒå¤±ã‚ã‚Œã‚‹

```sql
-- æœˆæ¬¡å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ
SELECT
    DATE_TRUNC('month', created_at) as month,
    SUM(amount) as revenue
FROM orders
GROUP BY 1;

-- è§£ç´„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ³¨æ–‡ã‚’æ¶ˆã—ã¦ã„ãŸã‚‰...
-- â†’ éå»ã®å£²ä¸ŠãŒå¤‰ã‚ã£ã¦ã—ã¾ã†
-- â†’ å‰å¹´åŒæœˆæ¯”ãŒè¨ˆç®—ã§ããªã„
```

### å•é¡Œ4ï¼šå†ç™»éŒ²æ™‚ã®ãƒˆãƒ©ãƒ–ãƒ«

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œã¾ãŸä½¿ã„ãŸããªã£ãŸã®ã§å†ç™»éŒ²ã—ã¾ã—ãŸã€
ã‚·ã‚¹ãƒ†ãƒ ã€Œæ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¾ã—ãŸã€
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œå‰ã®ãƒ‡ãƒ¼ã‚¿ã¯ï¼Ÿ ãƒã‚¤ãƒ³ãƒˆã¯ï¼Ÿ è³¼å…¥å±¥æ­´ã¯ï¼Ÿã€
ã‚·ã‚¹ãƒ†ãƒ ã€Œå…¨ã¦å‰Šé™¤æ¸ˆã¿ã§ã™ã€
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ...ã‚‚ã†ä½¿ã„ã¾ã›ã‚“ã€
```

---

## ãªãœã€Œå…¨éƒ¨æ®‹ã™ã€ã‚‚å±é™ºãªã®ã‹

### å•é¡Œ1ï¼šæ³•çš„ã«æ¶ˆã•ãªã‘ã‚Œã°ã„ã‘ãªã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹

```
ã€GDPR / å€‹äººæƒ…å ±ä¿è­·æ³•ã®è¦æ±‚ã€‘

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ã€Œå‰Šé™¤ã‚’æ±‚ã‚ã‚‹æ¨©åˆ©ã€ãŒã‚ã‚‹
- å¿…è¦ä»¥ä¸Šã«å€‹äººæƒ…å ±ã‚’ä¿æŒã—ã¦ã¯ã„ã‘ãªã„
- ç›®çš„ã‚’é”æˆã—ãŸã‚‰å‰Šé™¤ã™ã¹ã

é•åã—ãŸå ´åˆï¼š
- GDPR: å¹´é–“å£²ä¸Šã®4%ã¾ãŸã¯2000ä¸‡ãƒ¦ãƒ¼ãƒ­ã®åˆ¶è£é‡‘
- æ—¥æœ¬: 1å„„å††ä»¥ä¸‹ã®ç½°é‡‘ï¼ˆ2022å¹´æ”¹æ­£ï¼‰
```

### å•é¡Œ2ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒå¢—å¤§ã™ã‚‹

```
ä¿æŒã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿é‡ âˆ æƒ…å ±æ¼æ´©æ™‚ã®è¢«å®³

è§£ç´„ã‹ã‚‰5å¹´çµŒã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å€‹äººæƒ…å ±ãŒæ¼æ´©
â†’ã€Œãªãœã¾ã æŒã£ã¦ã„ãŸã®ã‹ã€ã¨å•ã‚ã‚Œã‚‹
â†’ ãƒ¬ãƒ”ãƒ¥ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ€ãƒ¡ãƒ¼ã‚¸
â†’ é›†å›£è¨´è¨Ÿã®ãƒªã‚¹ã‚¯
```

### å•é¡Œ3ï¼šã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆãŒéš›é™ãªãå¢—ãˆã‚‹

```
æœˆé–“è§£ç´„ç‡ 5%ã€æœˆé–“æ–°è¦ 1000äººã®ã‚µãƒ¼ãƒ“ã‚¹

1å¹´å¾Œ: ç´„ 600äººåˆ†ã®ã€Œæ­»ã‚“ã ãƒ‡ãƒ¼ã‚¿ã€
5å¹´å¾Œ: ç´„ 3000äººåˆ†ã®ã€Œæ­»ã‚“ã ãƒ‡ãƒ¼ã‚¿ã€

ã“ã‚Œã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚‚ï¼š
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã•ã‚Œã‚‹
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä½œã‚‰ã‚Œã‚‹
- ã‚¯ã‚¨ãƒªã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å½±éŸ¿ã™ã‚‹
```

---

## ãƒ‡ãƒ¼ã‚¿ã®åˆ†é¡ï¼šæ¶ˆã™ã¹ãã‚‚ã®ã€æ®‹ã™ã¹ãã‚‚ã®

### 4ã¤ã®ã‚«ãƒ†ã‚´ãƒªã§è€ƒãˆã‚‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ãƒ‡ãƒ¼ã‚¿ã®åˆ†é¡ãƒãƒˆãƒªã‚¯ã‚¹                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ã‚«ãƒ†ã‚´ãƒª       â”‚     å…·ä½“ä¾‹        â”‚   è§£ç´„æ™‚ã®å‡¦ç†         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â‘  è­˜åˆ¥æƒ…å ±      â”‚ æ°åã€ãƒ¡ãƒ¼ãƒ«ã€    â”‚ åŒ¿ååŒ– or å‰Šé™¤        â”‚
â”‚   (PII)        â”‚ ä½æ‰€ã€é›»è©±ç•ªå·    â”‚ ï¼ˆæ³•çš„ä¿å­˜æœŸé–“å¾Œï¼‰      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â‘¡ å–å¼•è¨˜éŒ²      â”‚ æ³¨æ–‡ã€æ±ºæ¸ˆã€      â”‚ ä¿æŒï¼ˆåŒ¿ååŒ–ã‚‚å¯ï¼‰     â”‚
â”‚                â”‚ è«‹æ±‚æ›¸           â”‚ ï¼ˆæ³•å®šä¿å­˜æœŸé–“ï¼‰        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â‘¢ è¡Œå‹•ãƒ­ã‚°      â”‚ ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã€    â”‚ é›†è¨ˆå¾Œå‰Šé™¤ or         â”‚
â”‚                â”‚ æ“ä½œå±¥æ­´         â”‚ ä¸€å®šæœŸé–“ã§å‰Šé™¤         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â‘£ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”Ÿæˆ  â”‚ æŠ•ç¨¿ã€ã‚³ãƒ¡ãƒ³ãƒˆã€  â”‚ ãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚‹         â”‚
â”‚   ã‚³ãƒ³ãƒ†ãƒ³ãƒ„    â”‚ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰     â”‚ ï¼ˆå‰Šé™¤ or åŒ¿ååŒ–ï¼‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å„ã‚«ãƒ†ã‚´ãƒªã®è©³ç´°

#### â‘  è­˜åˆ¥æƒ…å ±ï¼ˆPII: Personally Identifiable Informationï¼‰

```sql
-- users ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¾‹
CREATE TABLE users (
    id BIGINT PRIMARY KEY,
    email VARCHAR(255),        -- PII: åŒ¿ååŒ–å¯¾è±¡
    name VARCHAR(100),         -- PII: åŒ¿ååŒ–å¯¾è±¡
    phone VARCHAR(20),         -- PII: åŒ¿ååŒ–å¯¾è±¡
    address TEXT,              -- PII: åŒ¿ååŒ–å¯¾è±¡
    created_at TIMESTAMP,      -- ä¿æŒ
    canceled_at TIMESTAMP,     -- ä¿æŒ
    status VARCHAR(20)         -- ä¿æŒ
);
```

**å‡¦ç†æ–¹é‡ï¼š**
- è§£ç´„å³æ™‚ï¼šè«–ç†å‰Šé™¤ï¼ˆ`status = 'canceled'`ï¼‰
- ä¸€å®šæœŸé–“å¾Œï¼šåŒ¿ååŒ–ã¾ãŸã¯ç‰©ç†å‰Šé™¤

#### â‘¡ å–å¼•è¨˜éŒ²

```sql
-- orders ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¾‹
CREATE TABLE orders (
    id BIGINT PRIMARY KEY,
    user_id BIGINT,            -- FKï¼ˆãŸã ã—åˆ¶ç´„ã¯å¤–ã™ï¼‰
    order_number VARCHAR(50),   -- ä¿æŒï¼ˆç›£æŸ»ç”¨ï¼‰
    amount DECIMAL(10,2),      -- ä¿æŒï¼ˆä¼šè¨ˆç”¨ï¼‰
    tax DECIMAL(10,2),         -- ä¿æŒï¼ˆä¼šè¨ˆç”¨ï¼‰
    created_at TIMESTAMP,      -- ä¿æŒ
    -- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
    billing_name VARCHAR(100), -- ä¿æŒï¼ˆè«‹æ±‚æ›¸ã«å¿…è¦ï¼‰
    billing_address TEXT       -- ä¿æŒï¼ˆè«‹æ±‚æ›¸ã«å¿…è¦ï¼‰
);
```

**å‡¦ç†æ–¹é‡ï¼š**
- æ³•å®šä¿å­˜æœŸé–“ï¼ˆ7å¹´ã€œ10å¹´ï¼‰ã¯ä¿æŒ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å¾Œã‚‚å–å¼•è¨˜éŒ²ã¯æ®‹ã™
- å¿…è¦ã«å¿œã˜ã¦åŒ¿ååŒ–ï¼ˆuser_id ã‚’ NULL ã«ï¼‰

#### â‘¢ è¡Œå‹•ãƒ­ã‚°

```sql
-- access_logs ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¾‹
CREATE TABLE access_logs (
    id BIGINT PRIMARY KEY,
    user_id BIGINT,
    ip_address INET,           -- PII: ä¸€å®šæœŸé–“ã§å‰Šé™¤
    user_agent TEXT,
    path VARCHAR(255),
    created_at TIMESTAMP
);
```

**å‡¦ç†æ–¹é‡ï¼š**
- é›†è¨ˆãƒ»åˆ†æç”¨é€”ãªã‚‰ã€é›†è¨ˆå¾Œã«ç”Ÿãƒ‡ãƒ¼ã‚¿å‰Šé™¤
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç”¨é€”ãªã‚‰ã€90æ—¥ã€œ1å¹´ã§å‰Šé™¤
- è§£ç´„ã¨åŒæ™‚ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã„

#### â‘£ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”Ÿæˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆUGCï¼‰

```sql
-- posts ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¾‹
CREATE TABLE posts (
    id BIGINT PRIMARY KEY,
    user_id BIGINT,
    content TEXT,
    created_at TIMESTAMP,
    deleted_at TIMESTAMP       -- è«–ç†å‰Šé™¤ç”¨
);
```

**å‡¦ç†æ–¹é‡ï¼š**
- ã‚µãƒ¼ãƒ“ã‚¹ã®æ€§è³ªã«ã‚ˆã‚‹
- SNSï¼šæŠ•ç¨¿ã‚’æ®‹ã™ã‹ã€åŒ¿ååŒ–ã™ã‚‹ã‹ã€å‰Šé™¤ã™ã‚‹ã‹
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã™ã¹ã

---

## å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š4ã¤ã®å‰Šé™¤æˆ¦ç•¥

### ãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼šè«–ç†å‰Šé™¤ï¼ˆSoft Deleteï¼‰

```sql
-- å‰Šé™¤ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ã ã‘
UPDATE users
SET
    status = 'canceled',
    canceled_at = NOW()
WHERE id = 123;

-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§é™¤å¤–
SELECT * FROM users WHERE status != 'canceled';
```

**ãƒ¡ãƒªãƒƒãƒˆï¼š**
- å¾©å…ƒãŒå®¹æ˜“
- å‚ç…§æ•´åˆæ€§ã‚’ç¶­æŒ
- ç›£æŸ»å¯¾å¿œãŒå®¹æ˜“

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼š**
- ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆãªã„ï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼‰
- å…¨ã‚¯ã‚¨ãƒªã«æ¡ä»¶ãŒå¿…è¦
- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¦ä»¶ã‚’æº€ãŸã•ãªã„å¯èƒ½æ€§

**å‘ã„ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ï¼š**
- è§£ç´„å¾Œã®çŒ¶äºˆæœŸé–“ï¼ˆ30æ—¥ä»¥å†…ãªã‚‰å¾©å…ƒå¯èƒ½ãªã©ï¼‰
- å†ç™»éŒ²ã®å¯èƒ½æ€§ãŒé«˜ã„ã‚µãƒ¼ãƒ“ã‚¹

### ãƒ‘ã‚¿ãƒ¼ãƒ³2ï¼šåŒ¿ååŒ–ï¼ˆAnonymizationï¼‰

```sql
-- PIIã‚’åŒ¿ååŒ–ã€å–å¼•è¨˜éŒ²ã¯ä¿æŒ
UPDATE users
SET
    email = CONCAT('deleted_', id, '@anonymized.local'),
    name = CONCAT('Deleted User #', id),
    phone = NULL,
    address = NULL,
    status = 'anonymized',
    anonymized_at = NOW()
WHERE id = 123;

-- å–å¼•è¨˜éŒ²ã¯ãã®ã¾ã¾
-- orders.user_id = 123 ã¯æ®‹ã‚‹
-- billing_name, billing_address ã¯ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¨ã—ã¦æ®‹ã™
```

**ãƒ¡ãƒªãƒƒãƒˆï¼š**
- å–å¼•è¨˜éŒ²ã‚’ä¿æŒã—ã¤ã¤PIIã‚’å‰Šé™¤
- çµ±è¨ˆãƒ»åˆ†æã«ä½¿ãˆã‚‹
- æ³•çš„è¦ä»¶ã¨ privacy ã®ãƒãƒ©ãƒ³ã‚¹

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼š**
- å®Œå…¨ãªåŒ¿ååŒ–ã¯é›£ã—ã„ï¼ˆå†è­˜åˆ¥ãƒªã‚¹ã‚¯ï¼‰
- å¾©å…ƒä¸å¯èƒ½

**å‘ã„ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ï¼š**
- å–å¼•å±¥æ­´ã‚’é•·æœŸä¿å­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚µãƒ¼ãƒ“ã‚¹
- GDPRå¯¾å¿œãŒå¿…è¦ã ãŒã€ãƒ‡ãƒ¼ã‚¿åˆ†æã‚‚é‡è¦

### ãƒ‘ã‚¿ãƒ¼ãƒ³3ï¼šç‰©ç†å‰Šé™¤ï¼ˆHard Deleteï¼‰

```sql
-- é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ã¦å®Œå…¨å‰Šé™¤
BEGIN;

-- ä¾å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å…ˆã«å‰Šé™¤
DELETE FROM access_logs WHERE user_id = 123;
DELETE FROM user_sessions WHERE user_id = 123;
DELETE FROM notifications WHERE user_id = 123;

-- å–å¼•è¨˜éŒ²ã¯ user_id ã‚’ NULL ã«
UPDATE orders SET user_id = NULL WHERE user_id = 123;

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æœ¬ä½“ã‚’å‰Šé™¤
DELETE FROM users WHERE id = 123;

COMMIT;
```

**ãƒ¡ãƒªãƒƒãƒˆï¼š**
- å®Œå…¨ã«ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã‚‹
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å‰Šæ¸›
- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¦ä»¶ã‚’å®Œå…¨ã«æº€ãŸã™

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼š**
- å¾©å…ƒä¸å¯èƒ½
- å‚ç…§æ•´åˆæ€§ã®å•é¡Œ
- ç›£æŸ»å¯¾å¿œãŒå›°é›£

**å‘ã„ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ï¼š**
- æ³•å®šä¿å­˜æœŸé–“ã‚’éããŸãƒ‡ãƒ¼ã‚¿
- æ˜ç¤ºçš„ãªå‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆGDPRç­‰ï¼‰

### ãƒ‘ã‚¿ãƒ¼ãƒ³4ï¼šã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼ˆArchiveï¼‰

```sql
-- åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«/åˆ¥DBã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
INSERT INTO archived_users
SELECT *, NOW() as archived_at
FROM users
WHERE id = 123;

-- æœ¬ä½“ã‹ã‚‰å‰Šé™¤
DELETE FROM users WHERE id = 123;
```

**ãƒ¡ãƒªãƒƒãƒˆï¼š**
- æœ¬ç•ªDBã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¶­æŒ
- å¿…è¦æ™‚ã«å¾©å…ƒå¯èƒ½
- ç›£æŸ»å¯¾å¿œå¯èƒ½

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼š**
- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å…ˆã®ç®¡ç†ãŒå¿…è¦
- å¾©å…ƒæ™‚ã®æ•´åˆæ€§ç¢ºä¿ãŒè¤‡é›‘

**å‘ã„ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ï¼š**
- å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®é•·æœŸä¿å­˜
- ç›£æŸ»è¦ä»¶ãŒå³ã—ã„æ¥­ç•Œï¼ˆé‡‘èã€åŒ»ç™‚ï¼‰

---

## å®Ÿè£…ä¾‹ï¼šæ®µéšçš„å‰Šé™¤ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
è§£ç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: å³æ™‚    â”‚  è«–ç†å‰Šé™¤ + ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
â”‚ (è§£ç´„æ™‚)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 30æ—¥å¾Œ
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: çŒ¶äºˆå¾Œ   â”‚  è¡Œå‹•ãƒ­ã‚°å‰Šé™¤
â”‚ (30æ—¥å¾Œ)        â”‚  ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 1å¹´å¾Œ
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: 1å¹´å¾Œ   â”‚  PIIåŒ¿ååŒ–
â”‚                â”‚  UGCå‰Šé™¤/åŒ¿ååŒ–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 7å¹´å¾Œ
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: 7å¹´å¾Œ   â”‚  å–å¼•è¨˜éŒ²ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
â”‚ (æ³•å®šä¿å­˜æœŸé–“å¾Œ) â”‚  æ®‹å­˜ãƒ‡ãƒ¼ã‚¿ç‰©ç†å‰Šé™¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®Ÿè£…ã‚³ãƒ¼ãƒ‰ï¼ˆPython + SQLAlchemyï¼‰

```python
from datetime import datetime, timedelta
from enum import Enum
from sqlalchemy import update, delete
from sqlalchemy.orm import Session

class DeletionStage(Enum):
    ACTIVE = "active"
    CANCELED = "canceled"          # Step 1
    LOGS_DELETED = "logs_deleted"  # Step 2
    ANONYMIZED = "anonymized"      # Step 3
    ARCHIVED = "archived"          # Step 4


class UserDeletionService:
    """æ®µéšçš„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚µãƒ¼ãƒ“ã‚¹"""

    def __init__(self, db: Session):
        self.db = db

    def cancel_user(self, user_id: int) -> None:
        """Step 1: è§£ç´„æ™‚ã®å³æ™‚å‡¦ç†"""
        # è«–ç†å‰Šé™¤
        self.db.execute(
            update(User)
            .where(User.id == user_id)
            .values(
                status=DeletionStage.CANCELED.value,
                canceled_at=datetime.utcnow(),
                # ãƒ­ã‚°ã‚¤ãƒ³ä¸å¯ã«ã™ã‚‹
                password_hash=None,
                api_key=None,
            )
        )

        # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–
        self.db.execute(
            delete(UserSession).where(UserSession.user_id == user_id)
        )

        # ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        self._cancel_subscription(user_id)

        self.db.commit()

        # ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡
        self._send_cancellation_email(user_id)

    def delete_logs(self, user_id: int) -> None:
        """Step 2: è¡Œå‹•ãƒ­ã‚°ã®å‰Šé™¤ï¼ˆ30æ—¥å¾Œï¼‰"""
        user = self.db.query(User).filter(User.id == user_id).first()

        if not self._is_ready_for_stage(user, DeletionStage.CANCELED, days=30):
            return

        # ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°å‰Šé™¤
        self.db.execute(
            delete(AccessLog).where(AccessLog.user_id == user_id)
        )

        # é€šçŸ¥å±¥æ­´å‰Šé™¤
        self.db.execute(
            delete(Notification).where(Notification.user_id == user_id)
        )

        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        user.status = DeletionStage.LOGS_DELETED.value
        self.db.commit()

    def anonymize_user(self, user_id: int) -> None:
        """Step 3: PIIåŒ¿ååŒ–ï¼ˆ1å¹´å¾Œï¼‰"""
        user = self.db.query(User).filter(User.id == user_id).first()

        if not self._is_ready_for_stage(user, DeletionStage.LOGS_DELETED, days=365):
            return

        # PIIåŒ¿ååŒ–
        self.db.execute(
            update(User)
            .where(User.id == user_id)
            .values(
                email=f"deleted_{user_id}@anonymized.local",
                name=f"Deleted User #{user_id}",
                phone=None,
                address=None,
                status=DeletionStage.ANONYMIZED.value,
                anonymized_at=datetime.utcnow(),
            )
        )

        # UGCã®åŒ¿ååŒ–ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚‹ï¼‰
        self.db.execute(
            update(Post)
            .where(Post.user_id == user_id)
            .values(
                author_name="å‰Šé™¤ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼",
                # content ã¯æ®‹ã™ï¼ˆã¾ãŸã¯å‰Šé™¤ï¼‰
            )
        )

        self.db.commit()

    def archive_and_delete(self, user_id: int) -> None:
        """Step 4: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¨ç‰©ç†å‰Šé™¤ï¼ˆ7å¹´å¾Œï¼‰"""
        user = self.db.query(User).filter(User.id == user_id).first()

        if not self._is_ready_for_stage(user, DeletionStage.ANONYMIZED, days=365*7):
            return

        # å–å¼•è¨˜éŒ²ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
        self._archive_orders(user_id)

        # ç‰©ç†å‰Šé™¤
        self.db.execute(delete(User).where(User.id == user_id))

        self.db.commit()

    def _is_ready_for_stage(
        self, user, required_status: DeletionStage, days: int
    ) -> bool:
        """æ¬¡ã®æ®µéšã«é€²ã‚ã‚‹çŠ¶æ…‹ã‹ãƒã‚§ãƒƒã‚¯"""
        if user is None:
            return False
        if user.status != required_status.value:
            return False
        if user.canceled_at is None:
            return False

        threshold = datetime.utcnow() - timedelta(days=days)
        return user.canceled_at < threshold

    def _archive_orders(self, user_id: int) -> None:
        """å–å¼•è¨˜éŒ²ã‚’åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–"""
        orders = self.db.query(Order).filter(Order.user_id == user_id).all()

        for order in orders:
            archived = ArchivedOrder(
                original_id=order.id,
                order_number=order.order_number,
                amount=order.amount,
                tax=order.tax,
                created_at=order.created_at,
                billing_name=order.billing_name,  # ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
                billing_address=order.billing_address,
                archived_at=datetime.utcnow(),
            )
            self.db.add(archived)

        # å…ƒã®æ³¨æ–‡ã‹ã‚‰ user_id ã‚’å‰Šé™¤ï¼ˆå‚ç…§æ•´åˆæ€§ã®ãŸã‚ï¼‰
        self.db.execute(
            update(Order)
            .where(Order.user_id == user_id)
            .values(user_id=None)
        )
```

### ãƒãƒƒãƒã‚¸ãƒ§ãƒ–ã®å®Ÿè£…

```python
# deletion_batch.py
from datetime import datetime

def run_deletion_pipeline():
    """å®šæœŸå®Ÿè¡Œãƒãƒƒãƒï¼ˆæ¯æ—¥å®Ÿè¡Œï¼‰"""
    db = get_db_session()
    service = UserDeletionService(db)

    # Step 2: 30æ—¥çµŒéã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°å‰Šé™¤
    canceled_users = db.query(User).filter(
        User.status == DeletionStage.CANCELED.value,
        User.canceled_at < datetime.utcnow() - timedelta(days=30)
    ).all()

    for user in canceled_users:
        try:
            service.delete_logs(user.id)
            logger.info(f"Logs deleted for user {user.id}")
        except Exception as e:
            logger.error(f"Failed to delete logs for user {user.id}: {e}")

    # Step 3: 1å¹´çµŒéã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŒ¿ååŒ–
    logs_deleted_users = db.query(User).filter(
        User.status == DeletionStage.LOGS_DELETED.value,
        User.canceled_at < datetime.utcnow() - timedelta(days=365)
    ).all()

    for user in logs_deleted_users:
        try:
            service.anonymize_user(user.id)
            logger.info(f"User {user.id} anonymized")
        except Exception as e:
            logger.error(f"Failed to anonymize user {user.id}: {e}")

    # Step 4: 7å¹´çµŒéã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ»å‰Šé™¤
    anonymized_users = db.query(User).filter(
        User.status == DeletionStage.ANONYMIZED.value,
        User.canceled_at < datetime.utcnow() - timedelta(days=365*7)
    ).all()

    for user in anonymized_users:
        try:
            service.archive_and_delete(user.id)
            logger.info(f"User {user.id} archived and deleted")
        except Exception as e:
            logger.error(f"Failed to archive user {user.id}: {e}")
```

---

## ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. å–å¼•è¨˜éŒ²ã«ã¯ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’æŒã¤

```sql
-- âŒ æ‚ªã„ä¾‹ï¼šuser_id ã ã‘ã§å‚ç…§
CREATE TABLE orders (
    id BIGINT PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),  -- ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã§å›°ã‚‹
    amount DECIMAL(10,2)
);

-- âœ… è‰¯ã„ä¾‹ï¼šè«‹æ±‚æ™‚ç‚¹ã®æƒ…å ±ã‚’ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
CREATE TABLE orders (
    id BIGINT PRIMARY KEY,
    user_id BIGINT,  -- å‚ç…§ã®ã¿ï¼ˆFKåˆ¶ç´„ãªã—ï¼‰
    amount DECIMAL(10,2),
    -- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
    billing_name VARCHAR(100) NOT NULL,
    billing_email VARCHAR(255) NOT NULL,
    billing_address TEXT,
    created_at TIMESTAMP NOT NULL
);
```

### 2. å‰Šé™¤ç”¨ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚«ãƒ©ãƒ ã‚’ç”¨æ„

```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY,
    email VARCHAR(255),
    name VARCHAR(100),

    -- å‰Šé™¤ç®¡ç†ç”¨
    status VARCHAR(20) DEFAULT 'active',
    canceled_at TIMESTAMP,
    anonymized_at TIMESTAMP,
    deletion_scheduled_at TIMESTAMP,  -- ç‰©ç†å‰Šé™¤äºˆå®šæ—¥

    -- ç›£æŸ»ç”¨
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_canceled_at ON users(canceled_at)
    WHERE status = 'canceled';
```

### 3. å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®è¦‹ç›´ã—

```sql
-- âŒ å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãŒã‚ã‚‹ã¨å‰Šé™¤ã§ããªã„
ALTER TABLE orders
ADD CONSTRAINT fk_orders_user
FOREIGN KEY (user_id) REFERENCES users(id);

-- âœ… åˆ¶ç´„ã‚’å¤–ã™ã‹ã€ON DELETE SET NULL
ALTER TABLE orders
ADD CONSTRAINT fk_orders_user
FOREIGN KEY (user_id) REFERENCES users(id)
ON DELETE SET NULL;

-- ã¾ãŸã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã§æ•´åˆæ€§ã‚’ç®¡ç†
-- FKåˆ¶ç´„ãªã—ã§ user_id ã‚’æŒã¤
```

### 4. å‰Šé™¤å¯¾è±¡ã‚’æ˜ç¢ºã«ã™ã‚‹ãƒ“ãƒ¥ãƒ¼

```sql
-- å‰Šé™¤ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å¯è¦–åŒ–
CREATE VIEW deletion_pipeline AS
SELECT
    id,
    email,
    status,
    canceled_at,
    CASE
        WHEN status = 'canceled'
             AND canceled_at < NOW() - INTERVAL '30 days'
        THEN 'ready_for_log_deletion'

        WHEN status = 'logs_deleted'
             AND canceled_at < NOW() - INTERVAL '1 year'
        THEN 'ready_for_anonymization'

        WHEN status = 'anonymized'
             AND canceled_at < NOW() - INTERVAL '7 years'
        THEN 'ready_for_archive'

        ELSE 'waiting'
    END as next_action
FROM users
WHERE status IN ('canceled', 'logs_deleted', 'anonymized');
```

---

## æ³•çš„è¦ä»¶ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### GDPRï¼ˆEUä¸€èˆ¬ãƒ‡ãƒ¼ã‚¿ä¿è­·è¦å‰‡ï¼‰

```
â–¡ å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰30æ—¥ä»¥å†…ã«å¯¾å¿œã§ãã‚‹ã‹
â–¡ ã€Œå¿˜ã‚Œã‚‰ã‚Œã‚‹æ¨©åˆ©ã€ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‹
â–¡ å‡¦ç†ã®æ³•çš„æ ¹æ‹ ãŒã‚ã‚‹é–“ã ã‘ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã¦ã„ã‚‹ã‹
â–¡ ãƒ‡ãƒ¼ã‚¿ä¿è­·å½±éŸ¿è©•ä¾¡ï¼ˆDPIAï¼‰ã‚’å®Ÿæ–½ã—ãŸã‹
â–¡ å‰Šé™¤å®Œäº†ã‚’é€šçŸ¥ã™ã‚‹ä»•çµ„ã¿ãŒã‚ã‚‹ã‹
```

### æ—¥æœ¬ã®å€‹äººæƒ…å ±ä¿è­·æ³•

```
â–¡ åˆ©ç”¨ç›®çš„ã®é”æˆå¾Œã€é…æ»ãªãå‰Šé™¤ã—ã¦ã„ã‚‹ã‹
â–¡ æœ¬äººã‹ã‚‰ã®å‰Šé™¤è«‹æ±‚ã«å¯¾å¿œã§ãã‚‹ã‹
â–¡ å®‰å…¨ç®¡ç†æªç½®ã‚’è¬›ã˜ã¦ã„ã‚‹ã‹
â–¡ ç¬¬ä¸‰è€…æä¾›ã—ãŸãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã‚’é€£çµ¡ã§ãã‚‹ã‹
```

### æ¥­ç•Œåˆ¥ã®è¿½åŠ è¦ä»¶

```
ã€é‡‘èã€‘
â–¡ çŠ¯åæ³•ã«åŸºã¥ãå–å¼•è¨˜éŒ²ã‚’10å¹´ä¿å­˜ã—ã¦ã„ã‚‹ã‹
â–¡ é‡‘èæ¤œæŸ»ã«å¯¾å¿œã§ãã‚‹è¨˜éŒ²ãŒã‚ã‚‹ã‹

ã€åŒ»ç™‚ã€‘
â–¡ è¨ºç™‚è¨˜éŒ²ã‚’5å¹´ä»¥ä¸Šä¿å­˜ã—ã¦ã„ã‚‹ã‹
â–¡ æ‚£è€…ã®åŒæ„ãªãå‰Šé™¤ã—ã¦ã„ãªã„ã‹

ã€EC/å°å£²ã€‘
â–¡ å¸³ç°¿ãƒ»å–å¼•è¨˜éŒ²ã‚’7å¹´ä¿å­˜ã—ã¦ã„ã‚‹ã‹
â–¡ è¿”å“ãƒ»ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œã«å¿…è¦ãªæƒ…å ±ã‚’ä¿æŒã—ã¦ã„ã‚‹ã‹
```

---

## ã‚ˆãã‚ã‚‹è³ªå•ã¨å›ç­”

### Q1: è§£ç´„å¾Œã™ãã«å…¨å‰Šé™¤ã‚’æ±‚ã‚ã‚‰ã‚ŒãŸã‚‰ï¼Ÿ

```
A: æ³•çš„ä¿å­˜ç¾©å‹™ãŒã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã§ããªã„ã“ã¨ã‚’èª¬æ˜ã™ã‚‹ã€‚

å¯¾å¿œä¾‹ï¼š
1. PIIã¯å³æ™‚åŒ¿ååŒ–
2. å–å¼•è¨˜éŒ²ã¯æ³•å®šæœŸé–“ã¾ã§ä¿æŒï¼ˆåŒ¿ååŒ–æ¸ˆã¿ï¼‰
3. è¡Œå‹•ãƒ­ã‚°ã¯å³æ™‚å‰Šé™¤
4. å‰Šé™¤å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆã‚’é€ä»˜
```

### Q2: å†ç™»éŒ²ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ãŸã„

```
A: è«–ç†å‰Šé™¤æœŸé–“ä¸­ï¼ˆ30æ—¥ãªã©ï¼‰ã§ã‚ã‚Œã°å¾©å…ƒå¯èƒ½ãªè¨­è¨ˆã«ã™ã‚‹ã€‚

å®Ÿè£…ä¾‹ï¼š
- canceled_at ã‹ã‚‰30æ—¥ä»¥å†…ãªã‚‰å¾©å…ƒå¯èƒ½
- å¾©å…ƒæ™‚ã« email ã®ä¸€æ„æ€§ã‚’ãƒã‚§ãƒƒã‚¯
- å¾©å…ƒã—ãŸã“ã¨ã‚’æ˜ç¤ºçš„ã«è¨˜éŒ²
```

### Q3: å–å¼•è¨˜éŒ²ã¨å€‹äººæƒ…å ±ã‚’ã©ã†ç´ä»˜ã‘ã‚‹ï¼Ÿ

```
A: å–å¼•æ™‚ç‚¹ã§ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜ã—ã€å¾Œã‹ã‚‰ç´ä»˜ã‘ã«ä¾å­˜ã—ãªã„ã€‚

è¨­è¨ˆåŸå‰‡ï¼š
- orders ãƒ†ãƒ¼ãƒ–ãƒ«ã« billing_name, billing_email ã‚’æŒã¤
- users ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ¶ˆãˆã¦ã‚‚ orders ã¯è‡ªå·±å®Œçµ
- ç›£æŸ»æ™‚ã¯ orders å˜ä½“ã§å¯¾å¿œå¯èƒ½
```

### Q4: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«é€£æºã—ãŸãƒ‡ãƒ¼ã‚¿ã¯ï¼Ÿ

```
A: ãƒ‡ãƒ¼ã‚¿é€£æºå…ˆã«ã‚‚å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼š
â–¡ Analyticsï¼ˆGoogle Analyticsç­‰ï¼‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
â–¡ CRMï¼ˆSalesforceç­‰ï¼‰ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
â–¡ ãƒ¡ãƒ¼ãƒ«é…ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒªã‚¹ãƒˆå‰Šé™¤
â–¡ CDN/ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤
```

### Q5: å‰Šé™¤æ¼ã‚Œã‚’é˜²ãã«ã¯ï¼Ÿ

```
A: ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°ã¨è‡ªå‹•åŒ–ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã€‚

1. å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã® user_id ã‚«ãƒ©ãƒ ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
2. å‰Šé™¤ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã‚«ãƒãƒ¼ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
3. å®šæœŸçš„ã«ã€Œå­¤ç«‹ãƒ‡ãƒ¼ã‚¿ã€ã‚’ãƒã‚§ãƒƒã‚¯

-- å­¤ç«‹ãƒ‡ãƒ¼ã‚¿æ¤œå‡ºã‚¯ã‚¨ãƒª
SELECT 'orders' as table_name, COUNT(*)
FROM orders o
LEFT JOIN users u ON o.user_id = u.id
WHERE o.user_id IS NOT NULL AND u.id IS NULL;
```

---

## ä½¿ã„åˆ†ã‘æ—©è¦‹è¡¨

### ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—åˆ¥ã®å‡¦ç†æ–¹é‡

| ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ— | è§£ç´„æ™‚ | 30æ—¥å¾Œ | 1å¹´å¾Œ | 7å¹´å¾Œ |
|-------------|-------|-------|-------|-------|
| **ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹** | è«–ç†å‰Šé™¤ | - | åŒ¿ååŒ– | ç‰©ç†å‰Šé™¤ |
| **æ°åãƒ»ä½æ‰€** | è«–ç†å‰Šé™¤ | - | åŒ¿ååŒ– | ç‰©ç†å‰Šé™¤ |
| **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰** | å³æ™‚å‰Šé™¤ | - | - | - |
| **APIã‚­ãƒ¼** | å³æ™‚å‰Šé™¤ | - | - | - |
| **æ±ºæ¸ˆæƒ…å ±** | å³æ™‚å‰Šé™¤ | - | - | - |
| **å–å¼•è¨˜éŒ²** | ä¿æŒ | ä¿æŒ | ä¿æŒ | ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– |
| **ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°** | ä¿æŒ | å‰Šé™¤ | - | - |
| **æŠ•ç¨¿/UGC** | è«–ç†å‰Šé™¤ | - | åŒ¿ååŒ–/å‰Šé™¤ | - |
| **ãƒ•ã‚¡ã‚¤ãƒ«** | è«–ç†å‰Šé™¤ | ç‰©ç†å‰Šé™¤ | - | - |

### æ¥­ç¨®åˆ¥ã®æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³

| æ¥­ç¨® | åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ | ç‰¹è¨˜äº‹é … |
|------|-------------|---------|
| **SaaSï¼ˆä¸€èˆ¬ï¼‰** | æ®µéšçš„å‰Šé™¤ | å†ç™»éŒ²å¯¾å¿œã‚’è€ƒæ…® |
| **EC** | åŒ¿ååŒ– + é•·æœŸä¿å­˜ | å–å¼•è¨˜éŒ²7å¹´ä¿å­˜ |
| **é‡‘è** | ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– | 10å¹´ä¿å­˜ã€ç›£æŸ»å¯¾å¿œ |
| **åŒ»ç™‚** | ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– | 5å¹´ä»¥ä¸Šä¿å­˜ |
| **SNS** | åŒ¿ååŒ– or å‰Šé™¤ | UGCã®ãƒãƒªã‚·ãƒ¼æ˜ç¢ºåŒ– |
| **ã‚²ãƒ¼ãƒ ** | è«–ç†å‰Šé™¤ | å¾©å¸°ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ |

---

## ã¾ã¨ã‚ï¼šè¿·ã£ãŸã¨ãã®åˆ¤æ–­åŸºæº–

### 3ã¤ã®åŸå‰‡

```
1. æ¶ˆã•ãªã‘ã‚Œã°ã„ã‘ãªã„ã‚‚ã® â†’ æ¶ˆã™ï¼ˆPIIã€èªè¨¼æƒ…å ±ï¼‰
2. æ¶ˆã—ã¦ã¯ã„ã‘ãªã„ã‚‚ã® â†’ æ®‹ã™ï¼ˆæ³•å®šä¿å­˜ãƒ‡ãƒ¼ã‚¿ï¼‰
3. ã©ã¡ã‚‰ã§ã‚‚ã‚ˆã„ã‚‚ã® â†’ ãƒ“ã‚¸ãƒã‚¹åˆ¤æ–­ï¼ˆã‚³ã‚¹ãƒˆvsä¾¡å€¤ï¼‰
```

### æœ€ä½é™ã‚„ã‚‹ã¹ãã“ã¨

```
â–¡ ãƒ‡ãƒ¼ã‚¿ã®åˆ†é¡ã‚’è¡Œã†ï¼ˆPII / å–å¼•è¨˜éŒ² / ãƒ­ã‚° / UGCï¼‰
â–¡ æ³•çš„ä¿å­˜æœŸé–“ã‚’ç¢ºèªã™ã‚‹
â–¡ æ®µéšçš„å‰Šé™¤ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å®Ÿè£…ã™ã‚‹
â–¡ å–å¼•è¨˜éŒ²ã«ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’æŒãŸã›ã‚‹
â–¡ å‰Šé™¤å®Œäº†ã‚’è¨¼æ˜ã§ãã‚‹ä»•çµ„ã¿ã‚’ä½œã‚‹
```

### ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨

```
âœ— è§£ç´„æ™‚ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å³æ™‚ç‰©ç†å‰Šé™¤
âœ— å–å¼•è¨˜éŒ²ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ä¸€ç·’ã«æ¶ˆã™
âœ— æ³•å®šä¿å­˜æœŸé–“ã‚’ç„¡è¦–ã™ã‚‹
âœ— ã€Œã‚ã¨ã§è€ƒãˆã‚‹ã€ã§æ”¾ç½®ã™ã‚‹
```

---

## è¨­è¨ˆåˆ¤æ–­ã®èƒŒæ™¯

ã€Œå…¨éƒ¨æ¶ˆã™ã€ã‹ã€Œå…¨éƒ¨æ®‹ã™ã€ã®äºŒæŠã§è€ƒãˆãŒã¡ã ãŒã€ç¾å®Ÿã¯ãã†å˜ç´”ã§ã¯ãªã„ã€‚æ³•å‹™ã€é‹ç”¨ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã€ãƒ“ã‚¸ãƒã‚¹è¦ä»¶ãŒè¤‡é›‘ã«çµ¡ã¿åˆã†ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€ãã‚Œãã‚Œã®è¦³ç‚¹ã‚’æ•´ç†ã—ã€æ®µéšçš„ã«å‡¦ç†ã™ã‚‹è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æç¤ºã—ãŸã€‚

## ç¾å ´ã§ã®åˆ¤æ–­åŸºæº–

æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¨­è¨ˆã™ã‚‹ã¨ãã€ã¾ãšã€Œè§£ç´„å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’ã©ã†ã™ã‚‹ã‹ã€ã‚’è€ƒãˆã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€‚å¾Œã‹ã‚‰è€ƒãˆã‚‹ã¨ã€ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆã‚„FKåˆ¶ç´„ã®è¦‹ç›´ã—ãŒå¿…è¦ã«ãªã‚Šã€å¤§ããªæ‰‹æˆ»ã‚Šã«ãªã‚‹ã‹ã‚‰ã ã€‚ç‰¹ã«å–å¼•è¨˜éŒ²ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¯ã€æœ€åˆã‹ã‚‰è¨­è¨ˆã«å…¥ã‚Œã¦ãŠãã¹ãã ã€‚

## è¦‹ã‚‹ã¹ããƒã‚¤ãƒ³ãƒˆ

ä»–ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®è¨­è¨ˆã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã¨ãã€ã€Œã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ãŸã‚‰ã©ã†ãªã‚‹ï¼Ÿã€ã¨èãã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€‚FKåˆ¶ç´„ã§å‰Šé™¤ã§ããªã„ã€å–å¼•è¨˜éŒ²ãŒæ¶ˆãˆã‚‹ã€ãƒ­ã‚°ãŒå­¤ç«‹ã™ã‚‹ã€ã¨ã„ã£ãŸå•é¡ŒãŒè¦‹ã¤ã‹ã‚‹ã“ã¨ãŒå¤šã„ã€‚è§£ç´„ãƒ•ãƒ­ãƒ¼ã¯ã€è¨­è¨ˆã®å¥å…¨æ€§ã‚’æ¸¬ã‚‹è‰¯ã„ãƒªãƒˆãƒã‚¹è©¦é¨“ç´™ã«ãªã‚‹ã€‚
